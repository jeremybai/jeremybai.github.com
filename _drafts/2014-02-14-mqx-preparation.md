---
layout: post
title: "MQX机制分析——预备知识"
description: ""
categories: 
- C
tags: [MQX,操作系统,飞思卡尔]
---
{% include JB/setup %}

　　这篇主要介绍一些在分析代码时可能遇到的预备知识。



## MQX任务队列剖析 ##
　　在MQX中，使用任务队列将各种任务组织起来。在任务队列中，任务描述符保存了该任务指向前一个任务和后一个任务的指针。当任务被创建后，先加入到任务列表队列，随后任务被添加到相应优先级的任务就绪队列中，而能够获得运行的任务就是系统当前优先级最高就绪任务。若任务由于等待同步信号而被阻塞，则该任务被从就绪任务队列转移到所等待同步信号量的等待队列中；若任务调用了延时服务，任务就被转移到任务延时队列中。当任务的阻塞条件被解除进入就绪态时，任务又从等待队列中被转移到就绪任务队列中。也就是说，MQX中的任务总是处于某个任务队列的管理之下，从某种程度上看，任务所在的队列的属性就可以描述任务当前所处的状态。对就绪任务队列和延时任务队列的工作机制进行分析，逐步掌握MQX使用队列组织任务的管理方式，其它种类的任务队列与此类似，可参照学习。
### 1．就绪任务队列 ###
　　就绪任务队列是任务调度机构中最重要的任务队列之一。MQX在启动初始化时为每个现有的优先级创建一个就绪任务队列头节点，用于链接各优先级的就绪任务。其中“现有的优先级”是指任务模板列表中定义的所有任务优先级最大值N（优先级最低）到0，而N+1优先级的任务对应的是系统创建的空闲任务，空闲任务在系统初始化时创建。就绪任务队列的组织形式如下图所示。就绪队列为双向链表，当队列为空时，头节点中的队列首任务指针和队列尾任务指针都指向头节点自己。N+2个就绪任务队列头节点之间也以链表形式连接在一起。  
![](http://g.hiphotos.bdimg.com/album/s%3D1400%3Bq%3D90/sign=6884ea52af6eddc422e7b0ff09eb8d8c/5ab5c9ea15ce36d3b349478738f33a87e950b13c.jpg)
　　各优先级的就绪任务队列头节点在存储系统中是连续存放的，当需要查询当前非空的最高优先级的就绪任务队列时，将从优先级为0（值越小优先级越高）的就绪任务队列向优先级低的就绪任务队列依次查询，以空闲任务就绪队列为结束。MQX的空闲任务是对一个变量的递增运算，没有对其它系统资源的争用，因此只会被高优先级的任务抢占，而不会被阻塞。空闲任务在不运行的情况下，总是就绪的。
　　在系统运行时，允许动态调整任务的优先级，即可将任务挂在对应优先级的就绪任务队列中，但不能将任务调整到未创建头节点的就绪任务队列中。
### 2．延时任务队列 ###
　　延时任务队列是MQX对任务队列管理的一个典型的应用，处理操作系统环境下的延时操作。在操作系统环境下，一般不使用原地空跑的方式进行延时，实际上，MQX是通过使用延时任务队列，将需要延时等待的任务从就绪任务队列中移除并加入到延时任务队列中，从而让出CPU的使用权，MQX操作系统调度执行其他就绪任务。
　　当一个正在运行的任务调用_time_delay函数时，_time_delay函数将当前系统时刻与传入的延时时间参数相加，得到该任务延时的“延时时刻”，即唤醒任务的时刻，并把它记录到任务描述符节点TIMEOUT中，然后将任务从就绪任务队列中移除，以唤醒的时间顺序插入到延时任务队列中。延时队列的结构如下图所示，它由队头节点和任务描述符节点组成链表结构，延时任务队列的头节点在MQX系统初始化时创建，并将首地址记录在内核数据区的TIMEOUT_QUEUE指针成员中，便于对延时队列的访问。队头节点的SIZE记录当前延时队列的成员节点数，MAX指明延时队列最大允许的节点数，若MAX的值为0，则队列的长度没有限制。  
![](http://f.hiphotos.bdimg.com/album/s%3D1400%3Bq%3D90/sign=df040484718da9774a2f822f8061c368/d4628535e5dde711057b8441a5efce1b9c1661d8.jpg)  
　　整个操作系统以滴答节拍记录系统的运行时间，每过一个滴答周期，系统会执行一次滴答处理例程，更新系统时间。与此同时，MQX的滴答处理例程中还将对延时任务队列进行检查，当系统的时间与延时任务队列从队首节点开始的若干个延时任务的唤醒时刻一致时，将这些任务唤醒，使其进入就绪态，回到由任务描述符节点成员MY_QUEUE指定的就绪队列，等待系统的调度。
　　等待任务队列中的任务都是由于等待某项系统资源而被阻塞，从而被安排在该资源的等待队列中排队。延时任务队列是等待任务队列的典型应用，在延时任务队列中等待的资源是唤醒时刻的到来。在其它等待任务队列，如信号量等待队列、消息等待队列，其中的任务也是等待各自的资源到来，然后才能被唤醒排入就绪任务队列，待获得CPU使用权后获得运行。
